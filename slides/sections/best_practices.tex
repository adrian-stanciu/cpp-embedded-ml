% vim: set tw=78 aw sw=2 sts=2 noet:

\section{Best practices}

\begin{frame}{Best practices}
  \begin{itemize}
	\item Integer quantization optimization
	\item Cross-compilation
	\item Binary size analysis
	\item Updates
  \end{itemize}
\end{frame}

\begin{frame}{Integer quantization optimization}
  \begin{itemize}
	\item The process of converting 32-bit floating-point numbers to the 8-bit integer numbers
	\item Reduces the size of the model and decreases inference duration at the expense of accuracy
  \end{itemize}
\end{frame}

\begin{frame}{Cross-compilation}
  \begin{itemize}
	\item The process to compile code for one system, named target (e.g.
	aarch64), on a different system, named host (e.g. x86\_64)
	\item Enables faster builds
  \end{itemize}
\end{frame}

\begin{frame}[fragile]{Binary size analysis}
Using Google's Bloaty McBloatface \\
\ttfamily \$ bloaty image\_classifier -d symbols
  \lstset{basicstyle=\tiny, numbers=left}
  \begin{lstlisting}
    FILE SIZE        VM SIZE
 --------------  --------------
  44.1%  29.5Ki  48.2%  29.5Ki    [section .text]
   8.3%  5.53Ki   9.0%  5.53Ki    [section .dynstr]
   7.7%  5.12Ki   8.4%  5.12Ki    [section .eh_frame]
   7.3%  4.90Ki   8.0%  4.90Ki    [section .rela.dyn]
   5.4%  3.59Ki   0.0%       0    [Unmapped]
   5.0%  3.38Ki   5.5%  3.38Ki    [section .dynsym]
   4.8%  3.18Ki   5.2%  3.18Ki    [section .rodata]
   2.9%  1.97Ki   3.2%  1.97Ki    [section .rela.plt]
   2.7%  1.81Ki   0.0%       0    [ELF Headers]
   2.0%  1.37Ki   2.2%  1.37Ki    [section .data.rel.ro]
   2.0%  1.34Ki   2.2%  1.34Ki    [section .plt]
   1.6%  1.07Ki   1.7%  1.07Ki    [section .eh_frame_hdr]
   1.1%     760   1.2%     760    [section .gcc_except_table]
   1.0%     696   1.1%     696    [section .got.plt]
   0.9%     624   1.0%     624    [section .dynamic]
   0.9%     598   1.0%     598    [LOAD #2 [RX]]
   0.8%     530   0.9%     579    [11 Others]
   0.4%     288   0.5%     288    [section .gnu.version]
   0.4%     274   0.0%       0    [section .shstrtab]
   0.4%     244   0.4%     244    [section .gnu.hash]
   0.3%     208   0.3%     208    [section .gnu.version_r]
 100.0%  66.9Ki 100.0%  61.3Ki    TOTAL
  \end{lstlisting}
\end{frame}

\begin{frame}[fragile]{Binary size analysis}
If compiled with debug info (\texttt{-g}) \\
\ttfamily \$ bloaty image\_classifier -d symbols
  \lstset{basicstyle=\tiny, numbers=left}
  \begin{lstlisting}
    FILE SIZE        VM SIZE    
 --------------  -------------- 
  42.0%  1.76Mi   0.0%       0    [section .debug_info]
  40.8%  1.71Mi   0.0%       0    [section .debug_str]
   8.8%   377Ki   0.0%       0    [section .debug_loc]
   3.4%   145Ki   0.0%       0    [section .debug_ranges]
   1.9%  82.6Ki   0.0%       0    [section .debug_line]
   1.3%  53.9Ki  53.1%  32.6Ki    [87 Others]
   0.5%  22.3Ki   0.0%       0    [section .debug_abbrev]
   0.1%  5.25Ki   7.5%  4.61Ki    std::__introsort_loop<>()
   0.1%  5.07Ki   0.0%       0    [section .strtab]
   0.1%  4.85Ki   0.0%       0    [section .symtab]
   0.1%  4.09Ki   6.7%  4.09Ki    [section .dynstr]
   0.1%  3.76Ki   5.1%  3.11Ki    std::__adjust_heap<>()
   0.1%  3.63Ki   4.8%  2.97Ki    std::__insertion_sort<>()
   0.1%  3.59Ki   0.0%       0    [Unmapped]
   0.1%  3.56Ki   3.6%  2.18Ki    cvflann::anyimpl::big_any_policy<>
   0.1%  3.34Ki   0.0%       0    [section .debug_aranges]
   0.1%  3.15Ki   3.4%  2.07Ki    cvflann::anyimpl::small_any_policy<>
   0.1%  3.06Ki   4.9%  2.99Ki    ic::ImageClassifier::run()
   0.1%  2.97Ki   2.0%  1.23Ki    cvflann::anyimpl::typed_base_any_policy<>
   0.1%  2.83Ki   4.4%  2.71Ki    ic::ImageClassifier::ImageClassifier()
   0.1%  2.78Ki   4.5%  2.75Ki    main
 100.0%  4.19Mi 100.0%  61.3Ki    TOTAL
  \end{lstlisting}
\end{frame}

\begin{frame}{Updates}
The model can be updated:
  \begin{itemize}
	\item Together with the application (use \texttt{\#embed} from C23 and
	replace \texttt{tflite::FlatBufferModel::BuildFromFile()} with
	\texttt{tflite::FlatBufferModel::BuildFromBuffer()})
	\item Separately from the application
  \end{itemize}
\end{frame}

